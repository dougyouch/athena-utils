#!/usr/bin/env ruby

require 'athena-utils'
require 'optparse'

options = {
  database: nil,
  work_group: 'primary',
  query: nil,
  save: nil,
  console: false
}
OptionParser.new do |opts|
  opts.banner = "Usage: athena [options]"

  opts.on("-d", "--database DATABASE", "Athena DB") do |v|
    options[:database] = v
  end

  opts.on("-w WORK_GROUP", "Athena Work Group, default: primary") do |v|
    options[:output_location] = v
  end

  opts.on("-e", "--execute QUERY", "Execute SQL Query") do |v|
    options[:query] = v
  end

  opts.on('-s', '--save FILE', 'Save query results to file') do |v|
    options[:save] = v
  end

  opts.on('-c', '--console', 'Execute query and makes results available in irb') do
    options[:console] = true
  end
end.parse!

raise('must specify a database') unless options[:database]
raise('must specify work group for athean queries') unless options[:work_group]

@athena = AthenaUtils::AthenaClient.new(options[:database], options[:work_group])
def athena
  @athena
end

if options[:query]
  @results = athena.query(options[:query])
  def results
    @results
  end

  if options[:save]
    results.save(options[:save])
    exit
  end

  if options[:console]
    require 'irb'
    IRB.start
  else
    results.s3_object.body do |chunk|
      print chunk
    end
  end
else
  require 'irb'
  IRB.start
end
